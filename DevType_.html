<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevType // GAME ENGINE</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-confetti@2.10.1/tsparticles.confetti.bundle.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #09090b;
            --bg-panel: #18181b;
            --primary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --error: #ef4444;
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            --glass: rgba(24, 24, 27, 0.7);
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 100%, rgba(16, 185, 129, 0.05), transparent 50%);
        }

        /* --- HEADER --- */
        nav {
            width: 100%; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 50;
        }
        .logo { font-family: 'JetBrains Mono', monospace; font-weight: 800; font-size: 1.5rem; letter-spacing: -1px; background: linear-gradient(to right, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .user-profile { display: flex; align-items: center; gap: 12px; background: var(--border); padding: 6px 12px; padding-right: 16px; border-radius: 50px; border: 1px solid var(--border); cursor: pointer; transition: 0.3s; }
        .user-profile:hover { border-color: var(--primary); }
        .avatar { width: 28px; height: 28px; border-radius: 50%; background: var(--bg-dark); object-fit: cover; }
        .username { font-size: 0.85rem; font-weight: 600; }
        .status-dot { width: 8px; height: 8px; background: var(--error); border-radius: 50%; }
        .status-dot.online { background: var(--success); box-shadow: 0 0 5px var(--success); }

        /* --- MAIN --- */
        main { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 1100px; padding: 20px; gap: 20px; }

        /* --- CONTROLS --- */
        .controls { display: flex; gap: 15px; width: 100%; background: var(--glass); padding: 15px; border-radius: 12px; border: 1px solid var(--border); align-items: center; flex-wrap: wrap; }
        .input-group { display: flex; gap: 8px; align-items: center; }
        .divider { width: 1px; height: 30px; background: var(--border); margin: 0 5px; }
        
        select, input { background: var(--bg-dark); border: 1px solid var(--border); color: var(--text-main); padding: 8px 12px; border-radius: 6px; font-family: 'Inter', sans-serif; font-size: 0.85rem; outline: none; }
        select:focus, input:focus { border-color: var(--primary); }
        
        option { background: var(--bg-dark); }

        .btn { background: var(--bg-panel); border: 1px solid var(--border); color: var(--text-main); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.85rem;}
        .btn:hover { background: #27272a; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #7c3aed); border: none; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3); }
        .btn-primary:hover { transform: translateY(-1px); }

        /* --- EDITOR --- */
        .editor-window { width: 100%; height: 450px; background: var(--bg-panel); border-radius: 12px; border: 1px solid var(--border); position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .editor-header { background: #27272a; padding: 8px 15px; font-size: 0.8rem; color: var(--text-muted); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); }
        .dot { width: 10px; height: 10px; border-radius: 50%; }
        
        .repo-info { margin-left: auto; font-family: 'JetBrains Mono', monospace; display: flex; gap: 10px; overflow: hidden; align-items: center; }
        .repo-name { color: var(--accent); font-weight: bold; white-space: nowrap; }
        .file-path { color: var(--text-muted); opacity: 0.9; white-space: nowrap; font-weight: 600; }

        .typing-container { flex: 1; position: relative; padding: 25px; font-family: 'JetBrains Mono', monospace; font-size: 0.95rem; line-height: 1.6; overflow-y: auto; cursor: text; }
        .typing-container::-webkit-scrollbar { width: 8px; }
        .typing-container::-webkit-scrollbar-track { background: var(--bg-dark); }
        .typing-container::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        .typing-container.error-shake { animation: shake 0.4s; border: 1px solid var(--error); }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        #code-display { 
            white-space: pre-wrap; 
            word-break: break-all; 
            user-select: none; 
            padding-bottom: 100px;
            tab-size: 4; 
            -moz-tab-size: 4; 
        }
        #input-field { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; z-index: 10; cursor: default; resize: none; }

        .char { color: #52525b; border-radius: 2px; }
        .char.correct { color: var(--text-main); text-shadow: 0 0 5px rgba(255,255,255,0.2); }
        
        /* Error Styling */
        .char.incorrect { 
            color: var(--error); 
            background: rgba(239, 68, 68, 0.2); 
            border-bottom: 2px solid var(--error);
        }
        
        /* Fehler bei Leerzeichen (muss sichtbar sein) */
        .char.incorrect.space-error {
            display: inline-block;
            min-width: 8px;
        }

        /* Fehler bei Enter (muss Zeilenumbruch behalten!) */
        .char.incorrect.newline-error {
            background: rgba(239, 68, 68, 0.3);
            /* KEIN display: inline-block hier, sonst geht der Umbruch kaputt */
            position: relative;
        }
        /* Kleines Enter-Symbol anzeigen */
        .char.incorrect.newline-error::before {
            content: '‚Üµ';
            font-size: 0.8em;
            position: absolute;
            left: 0;
            color: var(--error);
            opacity: 0.7;
        }

        /* Extra Zeichen am Ende */
        .char.extra {
            color: #7f1d1d;
            background: var(--error);
            opacity: 0.8;
        }

        .char.current { background: var(--accent); color: var(--bg-dark); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.7; } }

        /* --- STATS --- */
        .stats-bar { display: flex; gap: 20px; width: 100%; margin-top: 10px; }
        .stat-card { flex: 1; background: var(--glass); padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 2rem; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stat-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-top: 5px; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 100; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal { background: var(--bg-panel); width: 400px; padding: 30px; border-radius: 20px; border: 1px solid var(--border); transform: scale(0.9); transition: 0.3s; text-align: center; }
        .modal-overlay.active .modal { transform: scale(1); }
        
        .spinner { width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <nav>
        <div class="logo">DEVTYPE_</div>
        <div class="user-profile" onclick="openAuthModal()">
            <div class="status-dot" id="auth-dot"></div>
            <span class="username" id="auth-name">Connect GitHub</span>
            <img src="https://github.com/github.png" class="avatar" id="auth-avatar">
        </div>
    </nav>

    <main>
        <div class="controls">
            <div class="input-group">
                <select id="source-mode" onchange="toggleSourceMode()">
                    <option value="preset">‚ö° Quick Play</option>
                    <option value="custom">üõ† Custom Repo</option>
                </select>
            </div>
            <div class="input-group" id="preset-controls">
                <select id="preset-lang">
                    <optgroup label="Game Engines">
                        <option value="godot" selected>Godot (GDScript)</option>
                        <option value="unity">Unity (C#)</option>
                        <option value="unreal">Unreal (C++)</option>
                    </optgroup>
                    <optgroup label="Web & Backend">
                        <option value="javascript">React (JS/TS)</option>
                        <option value="python">Django (Py)</option>
                        <option value="go">Kubernetes (Go)</option>
                        <option value="rust">Cargo (Rust)</option>
                        <option value="csharp">.NET Runtime</option>
                    </optgroup>
                </select>
            </div>
            <div class="input-group" id="custom-controls" style="display:none;">
                <input type="text" id="repo-input" placeholder="user/repo" style="width:140px">
            </div>

            <div class="divider"></div>

            <div class="input-group">
                <select id="length-select">
                    <option value="10">Kurz (10 Zeilen)</option>
                    <option value="25" selected>Mittel (25 Zeilen)</option>
                    <option value="50">Lang (50 Zeilen)</option>
                </select>
            </div>

            <div class="divider"></div>

            <div class="input-group" style="margin-left:auto;">
                <input type="text" id="seed-input" placeholder="Seed (Optional)" style="width: 100px; text-align: center; font-family: monospace;">
                <button class="btn btn-primary" onclick="initGame()">
                    <span id="btn-text">START</span>
                    <div class="spinner" id="loading-spinner"></div>
                </button>
            </div>
        </div>

        <div class="editor-window">
            <div class="editor-header">
                <div class="dot" style="background:#ef4444"></div>
                <div class="dot" style="background:#f59e0b"></div>
                <div class="dot" style="background:#10b981"></div>
                
                <div class="repo-info">
                    <span class="repo-name" id="repo-display">waiting...</span>
                    <span style="color:#52525b">/</span>
                    <span class="file-path" id="file-display">ready</span>
                </div>
            </div>
            
            <div class="typing-container" id="container" onclick="forceFocus()">
                <div id="code-display"></div>
                <textarea id="input-field" spellcheck="false" autocomplete="off" autocapitalize="off"></textarea>
            </div>
        </div>

        <div class="stats-bar">
            <div class="stat-card"><div class="stat-val" id="cpm">0</div><div class="stat-label">CPM</div></div>
            <div class="stat-card"><div class="stat-val" id="accuracy">100%</div><div class="stat-label">Accuracy</div></div>
            <div class="stat-card"><div class="stat-val" id="highscore-val">0</div><div class="stat-label">Best</div></div>
        </div>
    </main>

    <div class="modal-overlay" id="auth-modal">
        <div class="modal" style="text-align:left;">
            <h2>GitHub Connect</h2>
            <p style="color:var(--text-muted); font-size: 0.9rem;">Erstelle einen <b>Personal Access Token (Classic)</b> bei GitHub und f√ºge ihn hier ein. Nur lokal gespeichert.</p>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <input type="password" id="pat-input" placeholder="ghp_xxxxxxxxxxxx" style="flex:1;">
                <button class="btn btn-primary" onclick="saveToken()">Login</button>
            </div>
            <div style="margin-top:15px; font-size:0.8rem;">
                <a href="#" onclick="logout()" style="color:var(--error);">Logout</a> | 
                <a href="#" onclick="closeAuthModal()" style="color:var(--text-muted);">Schlie√üen</a>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="result-modal">
        <div class="modal">
            <div style="color:var(--accent); font-weight:bold;">COMPLETE</div>
            <div id="rank-display" style="font-size:2.5rem; font-weight:900; margin:10px 0;">SENIOR DEV</div>
            <div style="font-size:4rem; font-weight:bold; color:white; margin:10px 0;" id="final-cpm">0</div>
            <div class="stat-label">CPM</div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:30px;">
                <button class="btn" onclick="initGame()">N√§chstes File</button>
                <button class="btn btn-primary" onclick="generateNewSeed()">Neuer Seed</button>
            </div>
        </div>
    </div>

    <script>
        // --- GAME CONFIG ---
        const LANG_CONFIG = {
            godot: { owner: 'godotengine', repo: 'godot-demo-projects', extensions: ['.gd'] },
            unity: { owner: 'Unity-Technologies', repo: 'UnityCsReference', extensions: ['.cs'] },
            unreal: { owner: 'TomLooman', repo: 'ActionRoguelike', extensions: ['.cpp', '.h'] },
            csharp: { owner: 'dotnet', repo: 'runtime', extensions: ['.cs'] },
            javascript: { owner: 'facebook', repo: 'react', extensions: ['.js', '.jsx', '.ts', '.tsx'] },
            python: { owner: 'django', repo: 'django', extensions: ['.py'] },
            go: { owner: 'kubernetes', repo: 'kubernetes', extensions: ['.go'] },
            rust: { owner: 'rust-lang', repo: 'cargo', extensions: ['.rs'] }
        };
        const GLOBAL_VALID_EXTENSIONS = ['.cs', '.js', '.jsx', '.ts', '.tsx', '.py', '.go', '.rs', '.java', '.cpp', '.c', '.gd', '.h', '.hpp'];

        let currentText = "", startTime = null, timerInterval = null, isPlaying = false, githubToken = localStorage.getItem('devtype_token') || "";

        const displayEl = document.getElementById('code-display');
        const inputEl = document.getElementById('input-field');
        const container = document.getElementById('container');
        const spinner = document.getElementById('loading-spinner');
        const btnText = document.getElementById('btn-text');
        const seedInput = document.getElementById('seed-input');
        const repoDisplay = document.getElementById('repo-display');
        const fileDisplay = document.getElementById('file-display');
        const lengthSelect = document.getElementById('length-select');

        checkAuth();
        document.getElementById('highscore-val').innerText = localStorage.getItem('devtype_hs') || 0;

        function forceFocus() { inputEl.focus(); }

        // --- AUTH ---
        function openAuthModal() { document.getElementById('auth-modal').classList.add('active'); }
        function closeAuthModal() { document.getElementById('auth-modal').classList.remove('active'); }
        async function saveToken() {
            const token = document.getElementById('pat-input').value.trim();
            if(!token) return;
            try {
                const res = await fetch('https://api.github.com/user', { headers: { Authorization: `token ${token}` } });
                if(res.ok) {
                    const user = await res.json();
                    localStorage.setItem('devtype_token', token);
                    localStorage.setItem('devtype_user', JSON.stringify(user));
                    githubToken = token;
                    checkAuth();
                    closeAuthModal();
                    confetti({ particleCount: 50, spread: 70, origin: { y: 0.1 } });
                } else alert('Token ung√ºltig!');
            } catch(e) { alert('Verbindungsfehler'); }
        }
        function logout() {
            localStorage.removeItem('devtype_token'); localStorage.removeItem('devtype_user');
            githubToken = ""; checkAuth(); closeAuthModal();
        }
        function checkAuth() {
            const userStr = localStorage.getItem('devtype_user');
            if (userStr && githubToken) {
                const user = JSON.parse(userStr);
                document.getElementById('auth-name').innerText = user.login;
                document.getElementById('auth-avatar').src = user.avatar_url;
                document.getElementById('auth-dot').classList.add('online');
            } else {
                document.getElementById('auth-name').innerText = "Connect GitHub";
                document.getElementById('auth-avatar').src = "https://github.com/github.png";
                document.getElementById('auth-dot').classList.remove('online');
            }
        }

        // --- PRNG ---
        function cyrb128(str){let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762;for(let i=0,k;i<str.length;i++){k=str.charCodeAt(i);h1=h2^Math.imul(h1^k,597399067);h2=h3^Math.imul(h2^k,2869860233);h3=h4^Math.imul(h3^k,951274213);h4=h1^Math.imul(h4^k,2716044179);}return(h1^h2^h3^h4)>>>0;}
        function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}

        function toggleSourceMode() {
            const mode = document.getElementById('source-mode').value;
            document.getElementById('preset-controls').style.display = mode === 'preset' ? 'flex' : 'none';
            document.getElementById('custom-controls').style.display = mode === 'custom' ? 'flex' : 'none';
        }
        function generateNewSeed() { seedInput.value = Math.random().toString(36).substring(2, 7); initGame(); }
        function formatPath(path) {
            const parts = path.split('/');
            return parts.length > 3 ? '.../' + parts.slice(-3).join('/') : path;
        }

        // --- GAME INIT ---
        async function initGame() {
            document.getElementById('result-modal').classList.remove('active');
            container.classList.remove('error-shake');
            spinner.style.display = 'block'; btnText.style.display = 'none';
            inputEl.value = ''; displayEl.innerHTML = ''; document.getElementById('cpm').innerText = '0';
            isPlaying = false; clearInterval(timerInterval);

            let seed = seedInput.value.trim() || Math.random().toString(36).substring(2,7);
            seedInput.value = seed;
            let seedValue = cyrb128(seed);
            const targetLength = parseInt(lengthSelect.value);
            const mode = document.getElementById('source-mode').value;
            let owner, repo, allowedExtensions;

            if (mode === 'preset') {
                const config = LANG_CONFIG[document.getElementById('preset-lang').value];
                owner = config.owner; repo = config.repo; allowedExtensions = config.extensions;
            } else {
                const val = document.getElementById('repo-input').value;
                if(!val.includes('/')) { alert("Repo Format: user/repo"); spinner.style.display='none'; btnText.style.display='block'; return; }
                [owner, repo] = val.split('/');
                allowedExtensions = GLOBAL_VALID_EXTENSIONS;
            }

            try {
                const headers = githubToken ? { Authorization: `token ${githubToken}` } : {};
                const treeRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/git/trees/HEAD?recursive=1`, { headers });
                if(!treeRes.ok) throw new Error(treeRes.status === 403 ? "API Limit! Login n√∂tig." : "Repo nicht gefunden");
                
                const treeData = await treeRes.json();
                const files = treeData.tree.filter(n => n.type === 'blob' && allowedExtensions.some(ext => n.path.endsWith(ext)));
                if(files.length === 0) throw new Error(`Keine Dateien gefunden!`);

                let attempts = 0, foundValidCode = false;
                while (!foundValidCode && attempts < 10) {
                    attempts++;
                    const currentRng = mulberry32(seedValue + attempts); 
                    const file = files[Math.floor(currentRng() * files.length)];
                    const fileRes = await fetch(file.url, { headers });
                    const fileData = await fileRes.json();
                    const content = new TextDecoder().decode(Uint8Array.from(atob(fileData.content), c => c.charCodeAt(0)));
                    const snippet = extractSnippet(content, currentRng, targetLength);
                    
                    if (snippet) {
                        foundValidCode = true;
                        currentText = snippet;
                        repoDisplay.innerText = `${owner}/${repo}`;
                        fileDisplay.innerText = formatPath(file.path);
                        fileDisplay.title = file.path;
                        renderCode();
                        inputEl.focus();
                    }
                }
                if (!foundValidCode) throw new Error(`Keine passende Datei gefunden.`);
            } catch(e) {
                repoDisplay.innerText = "ERROR"; fileDisplay.innerText = ""; displayEl.innerText = e.message;
            }
            spinner.style.display = 'none'; btnText.style.display = 'block';
        }

        function extractSnippet(code, rng, targetLength) {
            const lines = code.split('\n').filter(l => l.trim().length > 1 && !l.trim().startsWith('//') && !l.trim().startsWith('#'));
            if (lines.length < targetLength) return null;
            const start = Math.floor(rng() * Math.max(0, lines.length - targetLength));
            return lines.slice(start, start + targetLength).join('\n').substring(0, 3000).trim();
        }

        function renderCode() {
            displayEl.innerHTML = '';
            currentText.split('').forEach(char => {
                const s = document.createElement('span');
                s.innerText = char; s.className = 'char';
                displayEl.appendChild(s);
            });
            if(displayEl.firstChild) displayEl.firstChild.classList.add('current');
        }

        // --- INPUT & SMART TAB ---
        inputEl.addEventListener('input', () => {
            if(!isPlaying && inputEl.value.length === 1) { isPlaying = true; startTime = new Date(); timerInterval = setInterval(()=>{}, 1000); }
            updateGame();
        });

        inputEl.addEventListener('keydown', (e) => {
            if(e.key === 'Tab') {
                e.preventDefault();
                const cursorIndex = inputEl.selectionStart;
                const expectedChar = currentText[cursorIndex];
                let textToInsert = '\t';

                // "Smart Tab": Wenn das n√§chste Zeichen ein Leerzeichen ist, alle Leerzeichen bis zum Wort einf√ºgen
                if (expectedChar === ' ') {
                    let spaceCount = 0;
                    while(currentText[cursorIndex + spaceCount] === ' ') spaceCount++;
                    if(spaceCount > 0) textToInsert = ' '.repeat(spaceCount);
                }

                const val = inputEl.value;
                inputEl.value = val.substring(0, cursorIndex) + textToInsert + val.substring(inputEl.selectionEnd);
                inputEl.selectionStart = inputEl.selectionEnd = cursorIndex + textToInsert.length;
                
                if(!isPlaying) { isPlaying = true; startTime = new Date(); timerInterval = setInterval(()=>{}, 1000); }
                updateGame();
                return;
            }
            if(['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End', 'PageUp', 'PageDown'].includes(e.key)) e.preventDefault();
        });
        
        inputEl.addEventListener('click', forceFocus);

        // --- GAME LOOP ---
        function updateGame() {
            const typed = inputEl.value;
            const originalChars = displayEl.querySelectorAll('.char:not(.extra)');
            
            // Alte Extras entfernen
            const nodes = Array.from(displayEl.childNodes);
            nodes.forEach(node => {
                if((node.nodeType === 1 && node.classList.contains('extra')) || (node.nodeType === 3 && node.textContent === '\n' && node.previousSibling && node.previousSibling.classList && node.previousSibling.classList.contains('extra'))) {
                    displayEl.removeChild(node);
                }
            });

            let errs = 0;

            // 1. Validierung
            originalChars.forEach((span, i) => {
                const char = typed[i];
                span.className = 'char';
                
                if(char == null) {
                    if(i === typed.length) {
                        span.classList.add('current');
                        const r = span.getBoundingClientRect();
                        const c = container.getBoundingClientRect();
                        if(r.bottom > c.bottom - 50) container.scrollTop += 30;
                    }
                } else if(char === currentText[i]) {
                    span.classList.add('correct');
                } else {
                    span.classList.add('incorrect');
                    
                    // Spezielle Fehlerklassen zuweisen
                    if (currentText[i] === '\n') {
                        // Enter vergessen! Klasse f√ºr visuelles Feedback, ABER ohne inline-block
                        span.classList.add('newline-error');
                    } else if (currentText[i] === ' ' || currentText[i] === '\t' || char === ' ' || char === '\t') {
                        // Leerzeichen Fehler (braucht inline-block damit sichtbar)
                        span.classList.add('space-error');
                    }
                    errs++;
                }
            });

            // 2. Extra Zeichen am Ende (Wenn User weitertippt)
            if (typed.length > currentText.length) {
                const extraCount = typed.length - currentText.length;
                for(let k=0; k < extraCount; k++) {
                    const idx = currentText.length + k;
                    const char = typed[idx];
                    const s = document.createElement('span');
                    
                    s.className = 'char extra';
                    
                    if(char === '\n') {
                        s.innerText = '‚Üµ'; 
                        displayEl.appendChild(s);
                        // Echten Umbruch erzwingen
                        displayEl.appendChild(document.createTextNode('\n'));
                    } else {
                        s.innerText = char;
                        if(char === ' ' || char === '\t') {
                            s.style.display = 'inline-block'; s.style.minWidth = '8px';
                        }
                        displayEl.appendChild(s);
                    }
                    errs++;
                }
                container.scrollTop = container.scrollHeight;
            }

            if(startTime) {
                const min = (new Date() - startTime) / 60000;
                const correct = typed.length - errs;
                document.getElementById('cpm').innerText = Math.round(correct / min) || 0;
                document.getElementById('accuracy').innerText = Math.round(((typed.length - errs) / typed.length) * 100) + "%";
            }

            if(typed === currentText) endGame();
            else if(errs > 0) container.classList.add('error-shake');
            else container.classList.remove('error-shake');
        }

        function endGame() {
            clearInterval(timerInterval); isPlaying = false; inputEl.blur();
            const cpm = document.getElementById('cpm').innerText;
            const val = parseInt(cpm);
            let rank="SCRIPT KIDDIE", color="#a1a1aa";
            if(val > 100) { rank="JUNIOR DEV"; color="#10b981"; }
            if(val > 200) { rank="SENIOR DEV"; color="#06b6d4"; }
            if(val > 300) { rank="TECH LEAD"; color="#8b5cf6"; }
            if(val > 400) { rank="10X ENGINEER"; color="#f59e0b"; }

            const rd = document.getElementById('rank-display');
            rd.innerText = rank; rd.style.color = color;
            document.getElementById('final-cpm').innerText = cpm;

            const oldHs = parseInt(localStorage.getItem('devtype_hs') || 0);
            if(val > oldHs) { localStorage.setItem('devtype_hs', val); document.getElementById('highscore-val').innerText = val; }

            document.getElementById('result-modal').classList.add('active');
            confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: [color, '#ffffff'] });
        }
    </script>
</body>
</html>